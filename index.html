<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MDPC Auth</title>
  <style>
    body { background: #121212; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
    input { margin: 8px 0; padding: 8px; width: 200px; }
    button { background: #1976d2; color: white; border: none; padding: 10px 20px; cursor: pointer; margin-top: 8px; }
    button:hover { background: #1565c0; }
    .error { color: #f44336; margin-top: 10px; }
  </style>
</head>
<body>

<h1>Login</h1>
<input id="email" type="email" placeholder="Email" />
<input id="password" type="password" placeholder="Password" />
<button onclick="login()">Login</button>
<div class="error" id="error"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBJGYpc-Zeb1WUs9_WYTZRp5Rrf3fyJlYk",
  authDomain: "danlogin-3e18f.firebaseapp.com",
  projectId: "danlogin-3e18f",
  appId: "1:661754509510:web:f2c29d318dca86dc6d3fc7"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
await setPersistence(auth, browserLocalPersistence);

function setCookie(name, value, days = 1) {
  const expires = new Date(Date.now() + days*864e5).toUTCString();
  document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/; domain=.miled-dev.xyz; SameSite=Lax`;
}

const params = new URLSearchParams(window.location.search);
const redirect = params.get("redirect") || "https://dan.miled-dev.xyz";

async function login() {
  const emailVal = document.getElementById("email").value.trim();
  const passVal = document.getElementById("password").value.trim();
  const error = document.getElementById("error");

  try {
    const userCredential = await signInWithEmailAndPassword(auth, emailVal, passVal);
    // ✅ User authenticated by Firebase → set cookie
    setCookie("mdpc_auth", "true", 1);
    setCookie("mdpc_user", emailVal, 1);

    window.location.replace(redirect);
  } catch(err) {
    error.innerText = err.message;
  }
}

// Optional: if already logged in via Firebase, auto-set cookie
onAuthStateChanged(auth, user => {
  if (user) {
    setCookie("mdpc_auth", "true", 1);
    setCookie("mdpc_user", user.email, 1);
  }
});
</script>

</body>
</html>
